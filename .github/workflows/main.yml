name: RDP + Rclone R2

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Configure Core RDP Settings
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create/Update RDP user
        shell: pwsh
        run: |
          $password = "${{ secrets.RDP_PASSWORD }}"
          if ([string]::IsNullOrWhiteSpace($password)) { throw "Missing secrets.RDP_PASSWORD" }
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          $u = Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
          if (-not $u) {
            New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires | Out-Null
          } else {
            Set-LocalUser -Name "RDP" -Password $securePass
          }
          Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue

      - name: Install Tailscale
        shell: pwsh
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        shell: pwsh
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
            $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4).Trim()
            Start-Sleep -Seconds 3
            $retries++
          }
          if (-not $tsIP) { throw "Tailscale IP not assigned" }
          "TAILSCALE_IP=$tsIP" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Tailscale IP: $tsIP"

      - name: Restrict RDP to your Tailscale IP only
        shell: pwsh
        run: |
          $clientIP = "${{ secrets.TS_CLIENT_IP }}"
          if ([string]::IsNullOrWhiteSpace($clientIP)) { throw "Missing secrets.TS_CLIENT_IP" }
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 remoteip=$clientIP

      - name: Install rclone + configure Cloudflare R2
        shell: pwsh
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:R2_ACCESS_KEY_ID)) { throw "Missing R2_ACCESS_KEY_ID" }
          if ([string]::IsNullOrWhiteSpace($env:R2_SECRET_ACCESS_KEY)) { throw "Missing R2_SECRET_ACCESS_KEY" }
          if ([string]::IsNullOrWhiteSpace($env:R2_ENDPOINT)) { throw "Missing R2_ENDPOINT" }
          $zipPath = Join-Path $env:TEMP "rclone.zip"
          $tempDir = Join-Path $env:TEMP "rclone-temp"
          $installDir = "C:\rclone"
          $rcloneExe = Join-Path $installDir "rclone.exe"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          if (Test-Path $tempDir) { Remove-Item $tempDir -Recurse -Force }
          if (-not (Test-Path $installDir)) { New-Item -ItemType Directory -Path $installDir | Out-Null }
          Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force
          $found = Get-ChildItem -Path $tempDir -Recurse -Filter "rclone.exe" | Select-Object -First 1
          if (-not $found) { throw "rclone.exe introuvable" }
          Copy-Item $found.FullName $rcloneExe -Force
          $configDir = Join-Path $env:APPDATA "rclone"
          if (-not (Test-Path $configDir)) { New-Item -ItemType Directory -Path $configDir | Out-Null }
          $configFile = Join-Path $configDir "rclone.conf"
          $configContent = "[r2cineprimee]`ntype = s3`nprovider = Cloudflare`naccess_key_id = $($env:R2_ACCESS_KEY_ID)`nsecret_access_key = $($env:R2_SECRET_ACCESS_KEY)`nregion = auto`nendpoint = $($env:R2_ENDPOINT)`nacl = private"
          $configContent | Set-Content -Path $configFile -Encoding UTF8
          & $rcloneExe version
          & $rcloneExe lsd "r2cineprimee:$($env:R2_BUCKET)"

      - name: Keep job alive
        shell: pwsh
        run: |
          Write-Host "=================================="
          Write-Host "RDP ADDRESS : $env:TAILSCALE_IP"
          Write-Host "USERNAME    : RDP"
          Write-Host "PASSWORD    : (secrets.RDP_PASSWORD)"
          Write-Host "=================================="
          while ($true) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session active..."
            Start-Sleep -Seconds 300
          }
